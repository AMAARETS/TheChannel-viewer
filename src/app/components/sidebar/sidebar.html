<!-- Sidebar -->
<nav class="sidebar"
     [class.collapsed]="(isExpanded$ | async) === false"
     (mouseenter)="onSidebarMouseEnter()"
     (mouseleave)="onSidebarMouseLeave()">
  <div class="sidebar-header">
    @if (isExpanded$ | async) {
      <div class="sidebar-logo">
        <span class="rotated-letter">ה</span>ערוץ
      </div>
    }
    <button
      class="toggle-sidebar-btn"
      (click)="toggleSidebar()"
      [title]="(isSidebarCollapsed$ | async) ? 'הרחב סרגל צד' : 'כווץ סרגל צד'"
    >
      <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M480-240 240-480l240-240 56 56-184 184 184 184-56 56Zm264 0L504-480l240-240 56 56-184 184 184 184-56 56Z"/></svg>
    </button>
  </div>

  <app-search-bar
    [isExpanded]="(isExpanded$ | async)!"
    (searchChanged)="onSearchChanged($event)"
    (expandAndFocus)="expandAndFocusSearch()">
  </app-search-bar>

  <div class="scrollable-content">
    @switch (dataLoadingState$ | async) {
      @case ('loading') {
        <div class="sidebar-message-container">
          <div class="spinner"></div>
          <span>טוען ערוצים...</span>
        </div>
      }
      @case ('error') {
        <div class="sidebar-message-container">
          <span>שגיאה בטעינת הנתונים</span>
        </div>
      }
      @case ('loaded') {
        @if ((filteredCategories$ | async); as filteredCategories) {
          <app-category-list
            [categories]="filteredCategories"
            [isExpanded]="(isExpanded$ | async)!"
            [activeSiteUrl]="(activeSiteUrl$ | async)"
            [collapsedState]="(categoryCollapseState$ | async)!"
            (siteSelected)="onSelectSite($event)"
            (categoryToggled)="onToggleCategory($event)"
            (contextMenuOpened)="onContextMenuOpen($event)"
            (categoriesUpdated)="onUpdateCategories($event)">
          </app-category-list>

          <app-available-sites
            [sites]="(filteredAvailableSites$ | async)!"
            [isExpanded]="(isExpanded$ | async)!"
            (siteAdded)="onAddSiteFromAvailable($event)">
          </app-available-sites>

          @if (searchTerm$ | async; as term) {
            @if (term && filteredCategories.length === 0 && (filteredAvailableSites$ | async)!.length === 0) {
              <div class="sidebar-message-container">
                <span>לא נמצאו ערוצים</span>
              </div>
            }
          } @else if ((siteDataService.categories$ | async)!.length === 0) {
            <div class="sidebar-message-container">
              <span>אין ערוצים להצגה.<br>אפשר להוסיף ערוץ חדש.</span>
            </div>
          }
        }
      }
    }
  </div>

  <div class="sidebar-footer">
    <button class="add-channel-btn" (click)="openAddSiteDialog()">
      @if (isExpanded$ | async) {
        <span>הוסף ערוץ </span>
      }
      <span>+</span>
    </button>
  </div>
</nav>

<!-- Global Context Menu Component -->
<app-context-menu
  [menuData]="contextMenuData"
  [allCategories]="(siteDataService.categories$ | async)!"
  (closed)="onContextMenuClose()"
  (deleteClicked)="onDeleteSite($event)"
  (categoryChangeClicked)="onChangeSiteCategory($event)"
  (newCategoryClicked)="onNewSiteCategory($event)"
  (moveUpClicked)="onMoveSiteUp($event)"
  (moveDownClicked)="onMoveSiteDown($event)">
</app-context-menu>