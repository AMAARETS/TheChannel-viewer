<!-- Sidebar -->
<nav class="sidebar"
     [class.collapsed]="(isExpanded$ | async) === false"
     (mouseenter)="onSidebarMouseEnter()"
     (mouseleave)="onSidebarMouseLeave()">
  <div class="sidebar-header">
    @if (isExpanded$ | async) {
      <div class="sidebar-logo">
        <span class="rotated-letter">ה</span>ערוץ
      </div>
    }
    <button
      class="toggle-sidebar-btn"
      (click)="toggleSidebar()"
      [title]="(isSidebarCollapsed$ | async) ? 'הרחב סרגל צד' : 'כווץ סרגל צד'"
    >
      <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M480-240 240-480l240-240 56 56-184 184 184 184-56 56Zm264 0L504-480l240-240 56 56-184 184 184 184-56 56Z"/></svg>
    </button>
  </div>

  <!-- Search -->
  <div class="search-bar">
    @if (isExpanded$ | async) {
      <input
        #searchInput
        type="text"
        class="search-input"
        placeholder="חיפוש ערוץ..."
        (input)="onSearch($event)"
      >
    } @else {
      <button class="search-icon-btn" (click)="expandAndFocusSearch()" title="חיפוש">
        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>
      </button>
    }
  </div>

  <div class="scrollable-content">
    <!-- Channels List by Category -->
    <div class="channel-list-container">
      @for (category of filteredCategories$ | async; track category.name) {
        <div
          class="category-drop-zone"
          draggable="true"
          (dragstart)="onCategoryDragStart($event, category)"
          (dragover)="onCategoryDragOver($event)"
          (dragleave)="onCategoryDragLeave($event)"
          (drop)="onCategoryDrop($event, category)"
          (dragend)="onCategoryDragEnd($event)"
          (dragenter)="onCategoryDragEnter($event)"
        >
          @if (isExpanded$ | async) {
            <h3 class="category-header"
                (click)="toggleCategory(category.name)"
                (keydown.enter)="toggleCategory(category.name)"
                tabindex="0"
                role="button"
                [attr.aria-expanded]="(isCategoryCollapsed(category.name) | async) === false">
              <span class="category-arrow" [class.expanded]="(isCategoryCollapsed(category.name) | async) === false"></span>
              {{ category.name }}
            </h3>
          } @else {
            <h3 class="category-header-collapsed" [title]="category.name">
              {{ getFirstLetter(category.name) }}
            </h3>
          }

          @if ((isCategoryCollapsed(category.name) | async) === false) {
            <ul class="site-list"
                (dragover)="onDragOverCategory($event, category)"
                (dragleave)="onDragLeaveCategory($event)"
                (drop)="onDropInCategory($event, category)">
              @for (site of category.sites; track site.url) {
                <li #listItem
                    (click)="selectSite(site)"
                    (keydown.enter)="selectSite(site)"
                    [class.active]="site.url === (activeSiteUrl$ | async)"
                    [class.menu-active]="isContextMenuOpenFor(site)"
                    [title]="site.name"
                    draggable="true"
                    (dragstart)="onDragStart($event, site, category)"
                    (dragover)="onDragOverSite($event, listItem)"
                    (dragleave)="onDragLeaveSite($event, listItem)"
                    (drop)="onDropOnSite($event, site, category)"
                    (dragend)="onDragEnd()"
                    tabindex="0"
                    role="button">
                  @if (!hasFaviconError(site)) {
                    <img [src]="getFaviconUrl(site.url)" (error)="onFaviconError(site)" class="site-icon" alt="">
                  } @else {
                    <div class="site-icon fallback-icon" [ngStyle]="{'background-color': getColorForSite(site.name)}">{{ getFirstLetter(site.name) }}</div>
                  }
                  @if (isExpanded$ | async) {
                    <span class="site-name">{{ site.name }}</span>
                    <div class="site-actions" (click)="$event.stopPropagation()">
                      <a [href]="site.url" target="_blank" class="action-btn" title="פתח בכרטיסייה חדשה"><svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="currentColor"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h560v-280h80v280q0 33-23.5 56.5T760-120H200Zm188-212-56-56 372-372H560v-80h280v280h-80v-144L388-332Z"/></svg></a>
                      <button class="action-btn menu-btn" (click)="toggleContextMenu(site, category, $event)" title="אפשרויות נוספות">
                        <svg xmlns="http://www.w3.org/2000/svg" height="18" viewBox="0 -960 960 960" width="18" fill="currentColor"><path d="M480-160q-33 0-56.5-23.5T400-240q0-33 23.5-56.5T480-320q33 0 56.5 23.5T560-240q0 33-23.5 56.5T480-160Zm0-240q-33 0-56.5-23.5T400-480q0-33 23.5-56.5T480-560q33 0 56.5 23.5T560-480q0 33-23.5 56.5T480-400Zm0-240q-33 0-56.5-23.5T400-720q0-33 23.5-56.5T480-800q33 0 56.5 23.5T560-720q0 33-23.5 56.5T480-640Z"/></svg>
                      </button>
                    </div>
                  }
                </li>
              }
            </ul>
          }
        </div>
      }
    </div>

    <!-- Available sites matching search -->
    @if (((filteredAvailableSites$ | async) ?? []).length > 0) {
      <div class="available-sites-container">
        <h4 class="available-sites-header">הוספה מהירה</h4>
        <ul class="available-site-list">
          @for (site of (filteredAvailableSites$ | async); track site.url) {
            <li
                (click)="addSiteFromAvailable(site)"
                (keydown.enter)="addSiteFromAvailable(site)"
                [title]="site.description"
                tabindex="0"
                role="button">
              @if (!hasFaviconError(site)) {
                <img [src]="getFaviconUrl(site.url)" (error)="onFaviconError(site)" class="site-icon" alt="">
              } @else {
                <div class="site-icon fallback-icon" [ngStyle]="{'background-color': getColorForSite(site.name)}">{{ getFirstLetter(site.name) }}</div>
              }
              @if (isExpanded$ | async) {
                <span class="site-name">{{ site.name }}</span>
                <button class="action-btn add-btn" title="הוסף ערוץ">+</button>
              }
            </li>
          }
        </ul>
      </div>
    }
  </div>

  <!-- Add Channel Button -->
  <div class="sidebar-footer">
    <button class="add-channel-btn" (click)="openAddSiteDialog()">
      @if (isExpanded$ | async) {
        <span>הוסף ערוץ </span>
      }
      <span>+</span>
    </button>
  </div>
</nav>

<!-- Global Context Menu -->
@if (contextMenuSiteUrl && activeMenuData) {
  <div class="context-menu"
       [ngStyle]="contextMenuPosition"
       [class.opens-up]="isMenuOpeningUp"
       (click)="$event.stopPropagation()">
    <div class="context-menu-item" (click)="openConfirmDeleteDialog(activeMenuData.site, $event)" (keydown.enter)="openConfirmDeleteDialog(activeMenuData.site, $event)" tabindex="0" role="menuitem">מחיקת ערוץ</div>
    <div class="context-menu-item-wrapper">
      <div class="context-menu-item with-submenu" tabindex="0" role="menuitem">
        העברה לקטגוריה
        <div class="context-submenu">
          @for (cat of (siteDataService.categories$ | async); track cat.name) {
            <div class="context-menu-item" (click)="changeSiteCategory(activeMenuData.site, activeMenuData.category, cat)" (keydown.enter)="changeSiteCategory(activeMenuData.site, activeMenuData.category, cat)" tabindex="0" role="menuitem">
              {{cat.name}}
            </div>
          }
          <hr class="context-divider">
          <div class="context-menu-item" (click)="promptForNewCategory(activeMenuData.site, activeMenuData.category)" (keydown.enter)="promptForNewCategory(activeMenuData.site, activeMenuData.category)" tabindex="0" role="menuitem">קטגוריה חדשה...</div>
        </div>
      </div>
    </div>
  </div>
}
