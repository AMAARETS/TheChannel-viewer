@if (isVisible$ | async) {
  <div class="dialog-overlay">
    <div #dialogBox class="dialog-box" (click)="$event.stopPropagation()" cdkTrapFocus cdkTrapFocusAutoCapture>
      <h2 class="dialog-title">הוספת ערוץ חדש</h2>
      <div class="dialog-content">
        <!-- START: FIX for possibly 'undefined' error -->
        @if ((filteredAvailableSites$ | async); as availableSites) {
          @if (availableSites.length > 0) {
            <h3 class="dialog-subtitle">הוספה מרשימה</h3>
            <ul class="available-sites-list">
              @for (site of availableSites; track site.url) {
                <li (click)="addSiteFromAvailable(site)" (keydown.enter)="addSiteFromAvailable(site)" tabindex="0" role="button">
                  <div class="site-info">
                    @if (!hasFaviconError(site)) {
                      <img [src]="getFaviconUrl(site.url)" (error)="onFaviconError(site)" class="site-icon" alt="">
                    } @else {
                      <div class="site-icon fallback-icon" [ngStyle]="{'background-color': getColorForSite(site.name)}">{{ getFirstLetter(site.name) }}</div>
                    }
                    <div class="site-details">
                      <span class="site-name">{{ site.name }}</span>
                      <span class="site-description">{{ site.description }}</span>
                    </div>
                  </div>
                  <button class="btn-add-from-list" aria-label="הוסף את {{site.name}}">+</button>
                </li>
              }
            </ul>
            <hr class="dialog-divider">
          }
        }
        <!-- END: FIX -->

        <h3 class="dialog-subtitle">הוספה ידנית</h3>
        <input #siteNameInput type="text" placeholder="שם הערוץ">
        <input #siteUrlInput type="text" placeholder="כתובת האתר">

        <input #siteCategoryInput
               type="text"
               placeholder="קטגוריה (למשל: חדשות)"
               (focus)="openCategoryDropdown(siteCategoryInput, dialogBox)"
               (blur)="closeCategoryDropdown()"
               (input)="onCategoryInput($event)">
      </div>
      <div class="dialog-actions">
        <button class="btn-secondary" (click)="closeDialog()">סגור</button>
        <button class="btn-primary" (click)="addSite(siteNameInput, siteUrlInput, siteCategoryInput)">שמור ערוץ ידני</button>
      </div>

      <!-- DROPDOWN LOGIC -->
      @if (isCategoryDropdownOpen && (filteredCategories$ | async); as categories) {
        @if (categories.length > 0) {
          <div class="category-dropdown" [ngStyle]="dropdownPosition">
            @for (category of categories; track category.name) {
              <div class="category-item" (mousedown)="selectCategory(category.name, siteCategoryInput)" (keydown.enter)="selectCategory(category.name, siteCategoryInput)" tabindex="0" role="option" [attr.aria-selected]="false">
                {{ category.name }}
              </div>
            }
          </div>
        }
      }
    </div>
  </div>
}
